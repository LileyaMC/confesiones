<!DOCTYPE ahtml>
<html>
<head>
    <title>Panel de Confesiones en Vivo</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://fonts.googleapis.com/css2?family=Righteous&family=Roboto:wght@400;700&family=Carattere&display=swap" rel="stylesheet">
    
    <style>
        /* 2. Definición de Paleta de Colores y Tipografía */
        :root {
            --color-principal: #884e96;
            --color-secundario: #eb598e;
            --color-terciario: #ffd981;
            --color-cian: #c2f8f9;
            --color-base-fondo: #f0c3ac; /* Color de fondo base */
        
            --font-titulo: 'Righteous', cursive;
            --font-cuerpo: 'Roboto', sans-serif;
        }

        /* --- ANIMACIONES --- */
        /* Animación de movimiento SOLO a la DERECHA */
        @keyframes subtleShift {
            0% { 
                background-position: 0 0; 
            }
            /* Mueve la imagen 300px a la derecha */
            100% { 
                background-position: 300px 0; 
            } 
        }
        @keyframes neonGlow {
            0% { text-shadow: 0 0 5px var(--color-secundario), 0 0 10px var(--color-principal); }
            50% { text-shadow: 0 0 15px var(--color-cian), 0 0 30px var(--color-secundario); }
            100% { text-shadow: 0 0 5px var(--color-secundario), 0 0 10px var(--color-principal); }
        }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* 3. Estilos Generales y Fondo */
        body {
            font-family: var(--font-cuerpo);
            color: var(--color-principal);
            padding: 0; 
            margin: 0;  
            display: flex;
            justify-content: center; 
            /* MODIFICADO: Centra la caja de contenido horizontalmente */
            align-items: center; 
            min-height: 100vh;
            background-color: var(--color-base-fondo); 
            position: relative; 
        }
        
        /* --- PSEUDO-ELEMENTO: CAPA DE IMAGEN DE FONDO FIJA Y ANIMADA --- */
        body::before {
            content: '';
            position: fixed; 
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; 
            
            /* CLAVE: Usamos la URL de la imagen (definida en el script) */
            background-image: var(--fondo-imagen-url);
            
            background-repeat: repeat; 
            
            /* Nubes pequeñas (ajustes anteriores) */
            background-size: 200px 200px; 
            background-position: 50px 50px; 
            
            /* CLAVE: Transparencia ajustada */
            opacity: 0.4; 
            
            /* Animación más rápida (ajustes anteriores) */
            animation: subtleShift 15s linear infinite; 
        }

        .container {
            max-width: 900px;
            width: 95%;
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4); 
            border: 4px solid var(--color-principal); 
            /* Se eliminan márgenes que causaban el desplazamiento visual */
            margin: 20px auto 40px auto; 
            z-index: 1;
        }

        h1 {
            font-family: var(--font-titulo);
            font-size: 3em;
            text-align: center;
            color: var(--color-secundario); 
            text-shadow: 1px 1px 0 var(--color-principal); 
            margin-bottom: 20px;
            animation: neonGlow 2.5s infinite alternate ease-in-out; 
        }
        
        #status {
            text-align: center;
            margin-bottom: 15px;
            color: white;
            font-weight: bold;
            padding: 10px;
            background-color: var(--color-principal);
            border-radius: 5px;
        }
        
        #confessions-list {
            margin-top: 30px;
            display: flex;
            flex-direction: column-reverse; 
            gap: 20px;
        }

        .confession-card {
            background-color: var(--color-cian); 
            padding: 20px;
            border-radius: 10px;
            border-left: 8px solid var(--color-principal);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.5s ease-in-out; 
        }
        
        .confession-card.new { 
            animation: fadeIn 0.5s ease-out; 
        }

        .confession-card p {
            font-family: var(--font-cuerpo);
            font-size: 1.2em;
            color: var(--color-principal);
            white-space: pre-wrap;
            margin-top: 0;
            margin-bottom: 15px;
        }

        .confession-meta {
            font-size: 0.85em;
            color: var(--color-principal);
            font-weight: bold;
            border-top: 1px dashed var(--color-panal-oscuro);
            padding-top: 5px;
            display: flex;
            justify-content: flex-start;
            align-items: center;
        }
        
    </style>
</head>
<body>

    <div class="container">
        
        <h1>Confesiones anónimas</h1>
        <p id="status">Cargando datos...</p>

        <div id="confessions-list">
            </div>
    </div>

    <script>
        // *************************************************************************
        // *** 1. CLAVE: RUTA O URL DE TU IMAGEN ***
        // Si está en la misma carpeta: url("nube.png")
        // Si es una URL pública: url("https://ejemplo.com/nube.png")
        // *************************************************************************
        const IMAGE_URL = 'url("nube-removebg-preview.png")'; 
        
        // Aplica la URL de la imagen a una variable CSS antes de iniciar
        document.documentElement.style.setProperty('--fondo-imagen-url', IMAGE_URL);
        // *************************************************************************
        
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwbq0AvLedkSaZ6bEaT_xsIiPtDH8Hx7DfRg9q9RM9IDWM69bmf-MzVCc-uqUYLXt5Twg/exec'; 
        const UPDATE_INTERVAL = 5000; 

        const listContainer = document.getElementById('confessions-list');
        const statusElement = document.getElementById('status');
        
        let lastRenderedTimestamps = new Set(); 

        // --- Funciones de Lectura y Renderizado Fluido ---
        
        function createConfessionCardHTML(item, isNew) {
            const date = new Date(item.timestamp).toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'medium' });
            const card = document.createElement('div');
            card.className = `confession-card ${isNew ? 'new' : ''}`;
            card.dataset.timestamp = String(item.timestamp); 
            card.innerHTML = `
                <p>${item.confesion}</p>`;
            return card;
        }

        function updateConfessionsList(newConfessions) {
            
            if (!newConfessions) newConfessions = [];
            
            const newTimestamps = newConfessions.map(item => String(item.timestamp));
            const newTimestampsSet = new Set(newTimestamps);
            
            let changed = false;

            // --- 1. Detección de Eliminación (Salida Fluida) ---
            const currentCards = Array.from(listContainer.querySelectorAll('.confession-card'));
            
            currentCards.forEach(card => {
                const cardTimestamp = card.dataset.timestamp;
                
                if (!newTimestampsSet.has(cardTimestamp)) {
                    card.style.opacity = '0';
                    card.style.margin = '0';
                    card.style.maxHeight = '0'; 
                    setTimeout(() => card.remove(), 500); 
                    changed = true;
                }
            });

            // --- 2. Detección de Adición (Entrada Fluida) ---
            const indicesToAdd = new Set(); 
            
            newTimestampsSet.forEach(timestamp => {
                if (!lastRenderedTimestamps.has(timestamp)) {
                    indicesToAdd.add(timestamp);
                    changed = true;
                }
            });
            
            // 3. Realizar la Inserción de Nuevos Elementos
            if (indicesToAdd.size > 0) {
                const fragment = document.createDocumentFragment();
                
                newConfessions.forEach(item => { 
                    if (indicesToAdd.has(String(item.timestamp))) {
                        const newCard = createConfessionCardHTML(item, true); 
                        fragment.appendChild(newCard); 
                        
                        setTimeout(() => newCard.classList.remove('new'), 500);
                    }
                });

                if (listContainer.firstChild) {
                    listContainer.insertBefore(fragment, listContainer.firstChild);
                } else {
                    listContainer.appendChild(fragment);
                }
            }

            // --- 4. Manejo de lista vacía ---
            if (newConfessions.length === 0 && listContainer.children.length === 0) {
                 listContainer.innerHTML = '<p style="text-align:center; font-style:italic; color: var(--color-secundario);">Aún no hay confesiones en el sistema.</p>';
                 changed = true;
            } 
            
            // 5. Actualizar la lista de identificadores renderizados para la próxima comparación
            lastRenderedTimestamps = newTimestampsSet;

            return changed; 
        }


        // 3. Función principal para obtener datos (GET)
        async function fetchAndRenderConfessions() {
            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                
                const changed = updateConfessionsList(data); 

                statusElement.textContent = `Total: ${data.length}`;
                
            } catch (error) {
                console.error('Error al obtener datos:', error);
                statusElement.textContent = '❌ Error de conexión. Reintentando... (Verifica SCRIPT_URL)';
            }
        }

        // --- Inicialización ---
        fetchAndRenderConfessions();
        setInterval(fetchAndRenderConfessions, UPDATE_INTERVAL);
    </script>
</body>
</html>
